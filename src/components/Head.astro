---
import "@styles/global.css";
import "@fontsource/inter/400.css";
import "@fontsource/inter/600.css";
import "@fontsource/lora/400.css";
import "@fontsource/lora/600.css";
import inter400 from "@fontsource/inter/files/inter-latin-400-normal.woff2";
import inter600 from "@fontsource/inter/files/inter-latin-600-normal.woff2";
import lora400 from "@fontsource/lora/files/lora-latin-400-normal.woff2";
import lora600 from "@fontsource/lora/files/lora-latin-600-normal.woff2";

import { ClientRouter } from "astro:transitions";
import { SITE } from "@consts";

interface Props {
    title: string;
    description: string;
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const { title, description } = Astro.props;
---

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link
    rel="icon"
    type="image/svg+xml"
    href="/favicon-dark.svg"
    media="(prefers-color-scheme: dark)"
/>
<link
    rel="icon"
    type="image/svg+xml"
    href="/favicon-light.svg"
    media="(prefers-color-scheme: light)"
/>

<meta name="generator" content={Astro.generator} />

<!-- Font preloads -->
<link rel="preload" href={inter400} as="font" type="font/woff2" crossorigin />
<link rel="preload" href={inter600} as="font" type="font/woff2" crossorigin />
<link rel="preload" href={lora400} as="font" type="font/woff2" crossorigin />
<link rel="preload" href={lora600} as="font" type="font/woff2" crossorigin />

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />

<ClientRouter />

<!-- RSS Link -->
<link
    rel="alternate"
    type="application/rss+xml"
    title={SITE.NAME}
    href={new URL("rss.xml", Astro.site)}
/>

<!-- disable font preloads on page change -->
<script>
    import type { TransitionBeforeSwapEvent } from "astro:transitions/client";
    document.addEventListener("astro:before-swap", (e) =>
        [
            ...(
                e as TransitionBeforeSwapEvent
            ).newDocument.head.querySelectorAll('link[as="font"]'),
        ].forEach((link) => link.remove()),
    );
</script>

<!-- theme handler -->
<script is:inline>
    function setTheme(theme) {
        const css = document.createElement("style");
        css.appendChild(
            document.createTextNode(`* {
             -webkit-transition: none !important;
             -moz-transition: none !important;
             -o-transition: none !important;
             -ms-transition: none !important;
             transition: none !important;
          }
        `),
        );

        document.head.appendChild(css);

        if (theme === "dark") {
            document.documentElement.classList.add("dark");
        } else {
            document.documentElement.classList.remove("dark");
        }

        window.getComputedStyle(css).opacity;
        document.head.removeChild(css);
    }

    function animate() {
        const animateElements = document.querySelectorAll(".animate");

        animateElements.forEach((element, index) => {
            setTimeout(() => {
                element.classList.add("show");
            }, index * 150);
        });
    }

    function runThemeButton() {
        const toggleThemeButton = document.getElementById("toggleThemeButton");

        toggleThemeButton?.addEventListener("click", () => {
            const currentTheme = document.documentElement.classList.contains(
                "dark",
            )
                ? "dark"
                : "light";

            const requiredTheme = currentTheme === "dark" ? "light" : "dark";

            localStorage.setItem("theme", requiredTheme);
            setTheme(requiredTheme);
        });
    }

    function preloadTheme() {
        const userTheme = localStorage.theme;

        if (userTheme === "light" || userTheme === "dark") {
            setTheme(userTheme);
        } else {
            const systemPrefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
            setTheme(systemPrefersDark ? "dark" : "light");
        }
    }

    function init(){
        preloadTheme()
        runThemeButton()
        animate()
    }

    preloadTheme();
    document.addEventListener("DOMContentLoaded", () => init());
    document.addEventListener("astro:after-swap", () => init());
</script>
